{% extends 'base.html' %}

{% comment %}
    context = {
        "mentored_issues": mentored_issues,
        "pr_requests_by_student": pr_requests_by_student,
        "pr_requests_for_mentor": pr_requests_for_mentor,
        "assignment_requests_by_student": assignment_requests_by_student,
        "assignment_requests_for_mentor": assignment_requests_for_mentor,
        'pr_form': pr_form,
    }
{% endcomment %}

{% block title %}
    User Profile
{% endblock %}

{% block content %}
    <button><a href="{% url 'home' %}">Home</a></button>
    {% if user.is_authenticated %}
        <button><a href="{% url 'logout' %}">Logout</a></button>
        <h2>Personal Information - </h2>
        <b>Username:</b> {{ user.username }}
{#        <br>#} |
        <b>Name:</b> {{ user.first_name }} {{ user.last_name }}
{#        <br>#} |
        <b>Role:</b> {{ user.userprofile.get_role_display }}
{#        <br>#} |
        <b>Registration Number:</b> {{ user.userprofile.registration_no }}
{#        <br>#} |
        <b>Course:</b> {{ user.userprofile.get_course_display }}
{#        <br>#} |
        <b>Current Year:</b> {{ user.userprofile.get_current_year_display }}
        |
        <b>Total Points: </b> {{ user.userprofile.total_points }}



        {% comment %}
            In Django templates you can use the "get_FOO_display()" method, that will return the readable alias
            for the field, where 'FOO' is the name of the field.
        {% endcomment %}

        <br>

        {% if user.userprofile.role == user.userprofile.STUDENT %}
            <h2>Currently Active Issues: </h2>
            <table border="2" cellpadding="10" cellspacing="5">
                <tr>
                    <th>Project</th>
                    <th>Issue #</th>
                    <th>Title</th>
                    <th>Mentor</th>
                    <th>State</th>
                    <th>Action</th>
                    <th>Remaining Time</th>
                </tr>
                {% for active_issue in active_issues %}
                    <tr>
                        <td><a href="{{ active_issue.issue.project.html_url }}">{{ active_issue.issue.project.name }}</a></td>
                        <td>{{ active_issue.issue.number }}</td>
                        <td><a href="{{ active_issue.issue.html_url }}">{{ active_issue.issue.title }}</a></td>
                        <td>{{ active_issue.issue.mentor }}</td>
                        <td>{{ active_issue.issue.get_state_display }}</td>
                        <td>
                            {# TODO:ISSUE Create Check on URL in frontend so that it is a Valid Github PR URL.#}
                            <form method="get" action="{% url 'submit_pr_request' active_issue.pk %}">
                                {{ pr_form.as_p }}
                                <button type="submit">Submit PR Link</button>
                            </form>
                        </td>
                        <td>{{ active_issue.get_remaining_time | timeuntil }}</td>
                        {# TODO:ISSUE: Implement Live Timer which ticks (instead of steady timer which changes on refreshing #}
                        {# TODO:ISSUE: Turn Timer Color to Red when last 1 hour is remaining.  #}
                    </tr>
                {% endfor %}
            </table>

            <h2>Current Assignment Requests: </h2>
            <table border="2" cellpadding="10" cellspacing="5">
                <tr>
                    <th>Project</th>
                    <th>#</th>
                    <th>Title</th>
                    <th>State</th>
                    <th>Mentor</th>
                </tr>
                {% for request in assignment_requests_by_student %}
                    <tr>
                        <td><a href="{{ request.issue.project.html_url }}">{{ request.issue.project.name }}</a></td>
                        <td>{{ request.issue.number }}</td>
                        <td><a href="{{ request.issue.html_url }}">{{ request.issue.title }}</a></td>
                        <td>{{ request.get_state_display }}</td>
                        <td>{{ request.issue.mentor.username }}</td>
                    </tr>
                {% endfor %}
            </table>

            <h2>PRs Submitted: </h2>
            <table border="2" cellpadding="10" cellspacing="5">
                <tr>
                    <th>Related Issue</th>
                    <th>Issue Number</th>
                    <th>State</th>
                </tr>
                {% for pr in pr_requests_by_student %}
                    <tr>
                        <td>{{ pr.issue.title }}</td>
                        <td>{{ pr.issue.number }}</td>
                        <td>{{ pr.get_state_display }}</td>
                    </tr>
                {% endfor %}
            </table>

        {% else %}
            {% if user.userprofile.role == user.userprofile.ADMIN %}
                <h2>Available Options - </h2>
                <button><a href="{% url 'populate_projects' %}">Populate Projects</a></button>
                <button><a href="{% url 'populate_issues' %}">Populate Issues</a></button>
            {% endif %}
            <h2>PR Verification Requests: </h2>
            <table border="2" cellpadding="10" cellspacing="5">
                <tr>
                    <th>Project</th>
                    <th>#</th>
                    <th>Title</th>
                    <th>State</th>
                    <th>Contributor</th>
                    <th>Submitted</th>
                    <th>Action</th>
                </tr>
                {% for pr in pr_requests_for_mentor %}
                    <tr>
                        <td><a href="{{ pr.issue.project.html_url }}">{{ pr.issue.project.name }}</a></td>
                        <td>{{ pr.issue.number }}</td>
                        <td><a href="{{ pr.issue.html_url }}">{{ pr.issue.title }}</a></td>
                        <td>{{ pr.get_state_display }}</td>
                        <td>{{ pr.contributor }}</td>
                        <td>{{ pr.submitted_at | timesince }} ago</td>
                        <td>
                            <button><a href="{{ pr.html_url }}" target="_blank">View PR</a></button>
                        {# TODO: ISSUE: Disable these buttons from Frontend if Issue is already accepted/rejected #}
                            <button><a href="{% url 'accept_pr' pr.pk %}">Accept</a></button>
                            <button><a href="{% url 'reject_pr' pr.pk %}">Reject</a></button>
                        </td>
                    </tr>
                {% endfor %}
            </table>

            <h2>Issue Assignment Requests: </h2>
            <table border="2" cellpadding="10" cellspacing="5">
                <tr>
                    <th>Project</th>
                    <th>#</th>
                    <th>Title</th>
                    <th>State</th>
                    <th>Requester</th>
                    <th>Action</th>
                </tr>
                {% for request in assignment_requests_for_mentor %}
                    <tr>
                        <td><a href="{{ request.issue.project.html_url }}">{{ request.issue.project.name }}</a></td>
                        <td>{{ request.issue.number }}</td>
                        <td><a href="{{ request.issue.html_url }}">{{ request.issue.title }}</a></td>
                        <td>{{ request.get_state_display }}</td>
                        <td>{{ request.requester }}</td>
                        <td>
                        {# TODO: ISSUE: Disable these buttons from Frontend if Issue is already accepted/rejected #}
                            <button><a href="{% url 'accept_issue_request' request.pk %}">Accept</a></button>
                            <button><a>Reject</a></button>
                        </td>
                    </tr>
                {% endfor %}
            </table>

            <h2>All Issues Under Me: </h2>
            <table border="2" cellpadding="10" cellspacing="5">
                <tr>
                    <th>Project</th>
                    <th>#</th>
                    <th>Title</th>
                    <th>State</th>
                </tr>
                {% for issue in mentored_issues %}
                    <tr>
                        <td><a href="{{ issue.project.html_url }}">{{ issue.project.name }}</a></td>
                        <td>{{ issue.number }}</td>
                        <td><a href="{{ issue.html_url }}">{{ issue.title }}</a></td>
                        <td>{{ issue.get_state_display }}</td>
                    </tr>
                {% endfor %}
            </table>
        {% endif %}
    {% else %}
        Hello, Anon. You need to Authorize with Github First.
    {% endif %}
{% endblock %}

{% block javascript %}

{% endblock %}
